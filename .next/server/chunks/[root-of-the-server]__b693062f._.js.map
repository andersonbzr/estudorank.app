{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 3, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 91, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/adsli/EstudoRank-patched-2025-10-22/estudorank/src/lib/supabase/server.ts"],"sourcesContent":["// src/lib/supabase/server.ts\r\nimport { createClient } from \"@supabase/supabase-js\";\r\n\r\nexport function supabaseServer() {\r\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL!;\r\n  const anon = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;\r\n  return createClient(url, anon, {\r\n    auth: {\r\n      persistSession: false,\r\n      autoRefreshToken: false,\r\n      detectSessionInUrl: false,\r\n    },\r\n  });\r\n}\r\n"],"names":[],"mappings":"AAAA,6BAA6B;;;;;AAC7B;;AAEO,SAAS;IACd,MAAM;IACN,MAAM;IACN,OAAO,IAAA,yMAAY,EAAC,KAAK,MAAM;QAC7B,MAAM;YACJ,gBAAgB;YAChB,kBAAkB;YAClB,oBAAoB;QACtB;IACF;AACF","debugId":null}},
    {"offset": {"line": 113, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/adsli/EstudoRank-patched-2025-10-22/estudorank/src/app/api/ranking/route.ts"],"sourcesContent":["// src/app/api/ranking/route.ts\nimport { NextResponse } from \"next/server\";\nimport { supabaseServer } from \"@/lib/supabase/server\";\n\n/**\n * Ranking endpoint\n * - Tries to query materialized aggregation view `user_points_view`\n *   (created via supabase/sql/001_user_points_view.sql)\n * - Falls back to in-app aggregation to avoid breaking if view missing\n */\nexport async function GET() {\n  const supabase = await supabaseServer();\n\n  // Try optimized view first\n  const fromView = await supabase\n    .from(\"user_points_view\")\n    .select(\"*\")\n    .limit(200);\n\n  if (!fromView.error && fromView.data) {\n    const leaderboard = fromView.data.map((r: any) => ({\n      user_id: r.user_id,\n      name: r.name,\n      points: r.total_points,\n      weeks: r.weeks_count ?? null,\n    }));\n    return NextResponse.json({ leaderboard });\n  }\n\n  // Fallback: aggregate from progress + profiles in JS\n  const { data: progress, error: progressErr } = await supabase\n    .from(\"progress\")\n    .select(\"user_id, points\");\n\n  const { data: profiles, error: profilesErr } = await supabase\n    .from(\"profiles\")\n    .select(\"id, name\");\n\n  if (progressErr || profilesErr || !progress || !profiles) {\n    return NextResponse.json({ error: \"Failed to compute ranking\" }, { status: 500 });\n  }\n\n  const map = new Map<string, { points: number; name: string }>();\n  for (const p of progress as any[]) {\n    const id = p.user_id as string;\n    const prev = map.get(id) ?? { points: 0, name: \"\" };\n    prev.points += p.points ?? 0;\n    map.set(id, prev);\n  }\n  for (const prof of profiles as any[]) {\n    const prev = map.get(prof.id);\n    if (prev) prev.name = prof.name ?? \"\";\n  }\n\n  const leaderboard = Array.from(map.entries())\n    .map(([user_id, v]) => ({ user_id, name: v.name, points: v.points }))\n    .sort((a, b) => b.points - a.points)\n    .slice(0, 200);\n\n  return NextResponse.json({ leaderboard });\n}\n"],"names":[],"mappings":"AAAA,+BAA+B;;;;;AAC/B;AACA;;;AAQO,eAAe;IACpB,MAAM,WAAW,MAAM,IAAA,oJAAc;IAErC,2BAA2B;IAC3B,MAAM,WAAW,MAAM,SACpB,IAAI,CAAC,oBACL,MAAM,CAAC,KACP,KAAK,CAAC;IAET,IAAI,CAAC,SAAS,KAAK,IAAI,SAAS,IAAI,EAAE;QACpC,MAAM,cAAc,SAAS,IAAI,CAAC,GAAG,CAAC,CAAC,IAAW,CAAC;gBACjD,SAAS,EAAE,OAAO;gBAClB,MAAM,EAAE,IAAI;gBACZ,QAAQ,EAAE,YAAY;gBACtB,OAAO,EAAE,WAAW,IAAI;YAC1B,CAAC;QACD,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE;QAAY;IACzC;IAEA,qDAAqD;IACrD,MAAM,EAAE,MAAM,QAAQ,EAAE,OAAO,WAAW,EAAE,GAAG,MAAM,SAClD,IAAI,CAAC,YACL,MAAM,CAAC;IAEV,MAAM,EAAE,MAAM,QAAQ,EAAE,OAAO,WAAW,EAAE,GAAG,MAAM,SAClD,IAAI,CAAC,YACL,MAAM,CAAC;IAEV,IAAI,eAAe,eAAe,CAAC,YAAY,CAAC,UAAU;QACxD,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAA4B,GAAG;YAAE,QAAQ;QAAI;IACjF;IAEA,MAAM,MAAM,IAAI;IAChB,KAAK,MAAM,KAAK,SAAmB;QACjC,MAAM,KAAK,EAAE,OAAO;QACpB,MAAM,OAAO,IAAI,GAAG,CAAC,OAAO;YAAE,QAAQ;YAAG,MAAM;QAAG;QAClD,KAAK,MAAM,IAAI,EAAE,MAAM,IAAI;QAC3B,IAAI,GAAG,CAAC,IAAI;IACd;IACA,KAAK,MAAM,QAAQ,SAAmB;QACpC,MAAM,OAAO,IAAI,GAAG,CAAC,KAAK,EAAE;QAC5B,IAAI,MAAM,KAAK,IAAI,GAAG,KAAK,IAAI,IAAI;IACrC;IAEA,MAAM,cAAc,MAAM,IAAI,CAAC,IAAI,OAAO,IACvC,GAAG,CAAC,CAAC,CAAC,SAAS,EAAE,GAAK,CAAC;YAAE;YAAS,MAAM,EAAE,IAAI;YAAE,QAAQ,EAAE,MAAM;QAAC,CAAC,GAClE,IAAI,CAAC,CAAC,GAAG,IAAM,EAAE,MAAM,GAAG,EAAE,MAAM,EAClC,KAAK,CAAC,GAAG;IAEZ,OAAO,gJAAY,CAAC,IAAI,CAAC;QAAE;IAAY;AACzC","debugId":null}}]
}
module.exports = [
"[project]/.next-internal/server/app/api/ranking/route/actions.js [app-rsc] (server actions loader, ecmascript)", ((__turbopack_context__, module, exports) => {

}),
"[externals]/next/dist/compiled/next-server/app-route-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-route-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/@opentelemetry/api [external] (next/dist/compiled/@opentelemetry/api, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/@opentelemetry/api", () => require("next/dist/compiled/@opentelemetry/api"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/next-server/app-page-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-page-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-unit-async-storage.external.js [external] (next/dist/server/app-render/work-unit-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-unit-async-storage.external.js", () => require("next/dist/server/app-render/work-unit-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-async-storage.external.js [external] (next/dist/server/app-render/work-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-async-storage.external.js", () => require("next/dist/server/app-render/work-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/shared/lib/no-fallback-error.external.js [external] (next/dist/shared/lib/no-fallback-error.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/shared/lib/no-fallback-error.external.js", () => require("next/dist/shared/lib/no-fallback-error.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/after-task-async-storage.external.js [external] (next/dist/server/app-render/after-task-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/after-task-async-storage.external.js", () => require("next/dist/server/app-render/after-task-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/action-async-storage.external.js [external] (next/dist/server/app-render/action-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/action-async-storage.external.js", () => require("next/dist/server/app-render/action-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/stream [external] (stream, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("stream", () => require("stream"));

module.exports = mod;
}),
"[externals]/http [external] (http, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("http", () => require("http"));

module.exports = mod;
}),
"[externals]/url [external] (url, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("url", () => require("url"));

module.exports = mod;
}),
"[externals]/punycode [external] (punycode, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("punycode", () => require("punycode"));

module.exports = mod;
}),
"[externals]/https [external] (https, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("https", () => require("https"));

module.exports = mod;
}),
"[externals]/zlib [external] (zlib, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("zlib", () => require("zlib"));

module.exports = mod;
}),
"[project]/src/lib/supabase/server.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

// src/lib/supabase/server.ts
__turbopack_context__.s([
    "supabaseServer",
    ()=>supabaseServer
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$headers$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/headers.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$supabase$2f$ssr$2f$dist$2f$module$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/node_modules/@supabase/ssr/dist/module/index.js [app-route] (ecmascript) <locals>");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$supabase$2f$ssr$2f$dist$2f$module$2f$createServerClient$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/@supabase/ssr/dist/module/createServerClient.js [app-route] (ecmascript)");
;
;
function supabaseServer() {
    const cookieStore = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$headers$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["cookies"])();
    return (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$supabase$2f$ssr$2f$dist$2f$module$2f$createServerClient$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServerClient"])(("TURBOPACK compile-time value", "https://mmrzhazdbqrwipxpygbn.supabase.co"), ("TURBOPACK compile-time value", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1tcnpoYXpkYnFyd2lweHB5Z2JuIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MDc2MTA0NiwiZXhwIjoyMDc2MzM3MDQ2fQ.5zSCkcLNhLSa4P42Rp0W5H9YShETgWYbifQkoLGHqlg"), {
        cookies: {
            get (name) {
                return cookieStore.get(name)?.value;
            },
            set (name, value, options) {
                cookieStore.set({
                    name,
                    value,
                    ...options
                });
            },
            remove (name, options) {
                cookieStore.set({
                    name,
                    value: "",
                    ...options
                });
            }
        }
    });
}
}),
"[project]/src/app/api/ranking/route.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

// app/api/ranking/route.ts
__turbopack_context__.s([
    "GET",
    ()=>GET,
    "dynamic",
    ()=>dynamic,
    "revalidate",
    ()=>revalidate
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/server.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$supabase$2f$supabase$2d$js$2f$dist$2f$module$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/node_modules/@supabase/supabase-js/dist/module/index.js [app-route] (ecmascript) <locals>");
var __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$supabase$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/src/lib/supabase/server.ts [app-route] (ecmascript)");
;
;
;
const dynamic = "force-dynamic";
const revalidate = 0;
function parseIntSafe(v, def) {
    if (!v) return def;
    const n = Number.parseInt(v, 10);
    return Number.isFinite(n) && n > 0 ? n : def;
}
/** Preferimos um client admin (service role) para evitar RLS na listagem global. */ async function getServerClient() {
    const url = ("TURBOPACK compile-time value", "https://mmrzhazdbqrwipxpygbn.supabase.co");
    const serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;
    if (url && serviceKey) {
        const client = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$supabase$2f$supabase$2d$js$2f$dist$2f$module$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["createClient"])(url, serviceKey, {
            auth: {
                persistSession: false,
                autoRefreshToken: false
            }
        });
        return {
            client,
            isAdmin: true
        };
    }
    // fallback: cookie-based (pode sofrer com RLS dependendo das policies)
    const client = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$supabase$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["supabaseServer"])();
    // @ts-expect-error: nosso helper retorna SupabaseClient
    return {
        client,
        isAdmin: false
    };
}
/** Utilitário para ordenar/recortar página em memória. */ function paginate(arr, page, pageSize) {
    const total = arr.length;
    const pages = Math.max(1, Math.ceil(total / pageSize));
    const from = (page - 1) * pageSize;
    const to = from + pageSize;
    const slice = arr.slice(from, to);
    return {
        slice,
        total,
        pages
    };
}
async function GET(req) {
    const url = new URL(req.url);
    const page = Math.max(1, parseIntSafe(url.searchParams.get("page"), 1));
    const pageSize = Math.min(100, Math.max(1, parseIntSafe(url.searchParams.get("pageSize"), 25)));
    try {
        const { client: supabase, isAdmin } = await getServerClient();
        /** ---------- 1) Tenta pela VIEW 'user_points_view' ---------- */ try {
            const { data, error, count } = await supabase.from("user_points_view").select("user_id,total,points,name,display_name,username,email", {
                count: "exact"
            }).order("total", {
                ascending: false
            }).range((page - 1) * pageSize, page * pageSize - 1);
            if (!error && Array.isArray(data)) {
                const leaderboard = data.filter((r)=>!!r.user_id).map((r)=>{
                    const val = typeof r.total === "number" && Number.isFinite(r.total) ? r.total : typeof r.points === "number" && Number.isFinite(r.points) ? r.points : 0;
                    const display = r.display_name || r.username || r.name || r.email || null;
                    return {
                        user_id: r.user_id,
                        name: display,
                        email: r.email ?? null,
                        points: val,
                        total: val
                    };
                });
                return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                    ok: true,
                    leaderboard,
                    page,
                    pageSize,
                    total: typeof count === "number" ? count : leaderboard.length,
                    pages: typeof count === "number" ? Math.max(1, Math.ceil(count / pageSize)) : 1,
                    via: "view",
                    adminClient: isAdmin
                }, {
                    headers: {
                        "Cache-Control": "no-store"
                    }
                });
            }
        // cai para fallback
        } catch  {
        // segue para fallback
        }
        /** ---------- 2) Fallback: agrega a partir de 'progress' ---------- */ try {
            const { data, error } = await supabase.from("progress").select("user_id,points").returns();
            if (!error && Array.isArray(data)) {
                const totals = new Map();
                for (const r of data){
                    if (!r.user_id) continue;
                    const add = Number.isFinite(r.points) ? r.points : 0;
                    totals.set(r.user_id, (totals.get(r.user_id) ?? 0) + add);
                }
                // Ordena por pontos desc
                const rows = [
                    ...totals.entries()
                ].map(([user_id, total])=>({
                        user_id,
                        total
                    })).sort((a, b)=>b.total - a.total);
                // Pagina em memória
                const { slice, total, pages } = paginate(rows, page, pageSize);
                // Busca perfis só dos usuários da página
                const ids = slice.map((r)=>r.user_id);
                let profiles = new Map();
                if (ids.length) {
                    const { data: profs } = await supabase.from("profiles").select("id,display_name,username,name,email").in("id", ids);
                    if (Array.isArray(profs)) {
                        profiles = new Map(profs.map((p)=>[
                                p.id,
                                {
                                    name: p.display_name || p.username || p.name || p.email || null,
                                    email: p.email ?? null
                                }
                            ]));
                    }
                }
                const leaderboard = slice.map((r)=>{
                    const p = profiles.get(r.user_id);
                    const val = r.total ?? 0;
                    return {
                        user_id: r.user_id,
                        name: p?.name ?? null,
                        email: p?.email ?? null,
                        points: val,
                        total: val
                    };
                });
                return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                    ok: true,
                    leaderboard,
                    page,
                    pageSize,
                    total,
                    pages,
                    via: "progress",
                    adminClient: isAdmin
                }, {
                    headers: {
                        "Cache-Control": "no-store"
                    }
                });
            }
        // cai para 3º fallback
        } catch  {
        // segue
        }
        /** ---------- 3) Último fallback: agrega a partir de 'points' ---------- */ const { data: pointsRows, error: pointsErr } = await supabase.from("points").select("user_id,value").returns();
        if (pointsErr) throw pointsErr;
        const totals = new Map();
        for (const r of pointsRows ?? []){
            if (!r.user_id) continue;
            const add = Number.isFinite(r.value) ? r.value : 0;
            totals.set(r.user_id, (totals.get(r.user_id) ?? 0) + add);
        }
        const rows = [
            ...totals.entries()
        ].map(([user_id, total])=>({
                user_id,
                total
            })).sort((a, b)=>b.total - a.total);
        const { slice, total, pages } = paginate(rows, page, pageSize);
        const ids = slice.map((r)=>r.user_id);
        let profiles = new Map();
        if (ids.length) {
            const { data: profs } = await supabase.from("profiles").select("id,display_name,username,name,email").in("id", ids);
            if (Array.isArray(profs)) {
                profiles = new Map(profs.map((p)=>[
                        p.id,
                        {
                            name: p.display_name || p.username || p.name || p.email || null,
                            email: p.email ?? null
                        }
                    ]));
            }
        }
        const leaderboard = slice.map((r)=>{
            const p = profiles.get(r.user_id);
            const val = r.total ?? 0;
            return {
                user_id: r.user_id,
                name: p?.name ?? null,
                email: p?.email ?? null,
                points: val,
                total: val
            };
        });
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            ok: true,
            leaderboard,
            page,
            pageSize,
            total,
            pages,
            via: "points",
            adminClient: isAdmin
        }, {
            headers: {
                "Cache-Control": "no-store"
            }
        });
    } catch (err) {
        console.error("[/api/ranking] error:", err?.message || err);
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            ok: false,
            error: err?.message ?? "server_error"
        }, {
            status: 500
        });
    }
}
}),
];

//# sourceMappingURL=%5Broot-of-the-server%5D__b693062f._.js.map
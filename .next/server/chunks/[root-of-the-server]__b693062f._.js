module.exports = [
"[project]/.next-internal/server/app/api/ranking/route/actions.js [app-rsc] (server actions loader, ecmascript)", ((__turbopack_context__, module, exports) => {

}),
"[externals]/next/dist/compiled/next-server/app-route-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-route-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/@opentelemetry/api [external] (next/dist/compiled/@opentelemetry/api, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/@opentelemetry/api", () => require("next/dist/compiled/@opentelemetry/api"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/next-server/app-page-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-page-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-unit-async-storage.external.js [external] (next/dist/server/app-render/work-unit-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-unit-async-storage.external.js", () => require("next/dist/server/app-render/work-unit-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-async-storage.external.js [external] (next/dist/server/app-render/work-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-async-storage.external.js", () => require("next/dist/server/app-render/work-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/shared/lib/no-fallback-error.external.js [external] (next/dist/shared/lib/no-fallback-error.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/shared/lib/no-fallback-error.external.js", () => require("next/dist/shared/lib/no-fallback-error.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/after-task-async-storage.external.js [external] (next/dist/server/app-render/after-task-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/after-task-async-storage.external.js", () => require("next/dist/server/app-render/after-task-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/action-async-storage.external.js [external] (next/dist/server/app-render/action-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/action-async-storage.external.js", () => require("next/dist/server/app-render/action-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/stream [external] (stream, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("stream", () => require("stream"));

module.exports = mod;
}),
"[externals]/http [external] (http, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("http", () => require("http"));

module.exports = mod;
}),
"[externals]/url [external] (url, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("url", () => require("url"));

module.exports = mod;
}),
"[externals]/punycode [external] (punycode, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("punycode", () => require("punycode"));

module.exports = mod;
}),
"[externals]/https [external] (https, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("https", () => require("https"));

module.exports = mod;
}),
"[externals]/zlib [external] (zlib, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("zlib", () => require("zlib"));

module.exports = mod;
}),
"[project]/src/lib/supabase/server.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

// src/lib/supabase/server.ts
__turbopack_context__.s([
    "supabaseServer",
    ()=>supabaseServer
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$headers$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/headers.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$supabase$2f$ssr$2f$dist$2f$module$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/node_modules/@supabase/ssr/dist/module/index.js [app-route] (ecmascript) <locals>");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$supabase$2f$ssr$2f$dist$2f$module$2f$createServerClient$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/@supabase/ssr/dist/module/createServerClient.js [app-route] (ecmascript)");
;
;
async function supabaseServer() {
    const cookieStore = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$headers$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["cookies"])(); // ðŸ‘ˆ importante
    return (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$supabase$2f$ssr$2f$dist$2f$module$2f$createServerClient$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServerClient"])(("TURBOPACK compile-time value", "https://mmrzhazdbqrwipxpygbn.supabase.co"), ("TURBOPACK compile-time value", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1tcnpoYXpkYnFyd2lweHB5Z2JuIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MDc2MTA0NiwiZXhwIjoyMDc2MzM3MDQ2fQ.5zSCkcLNhLSa4P42Rp0W5H9YShETgWYbifQkoLGHqlg"), {
        cookies: {
            get (name) {
                return cookieStore.get(name)?.value;
            },
            set (name, value, options) {
                cookieStore.set({
                    name,
                    value,
                    ...options
                });
            },
            remove (name, options) {
                cookieStore.set({
                    name,
                    value: "",
                    ...options
                });
            }
        }
    });
}
}),
"[project]/src/app/api/ranking/route.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

// app/api/ranking/route.ts
__turbopack_context__.s([
    "GET",
    ()=>GET,
    "dynamic",
    ()=>dynamic,
    "revalidate",
    ()=>revalidate
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/server.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$supabase$2f$supabase$2d$js$2f$dist$2f$module$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/node_modules/@supabase/supabase-js/dist/module/index.js [app-route] (ecmascript) <locals>");
var __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$supabase$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/src/lib/supabase/server.ts [app-route] (ecmascript)");
;
;
;
const dynamic = "force-dynamic";
const revalidate = 0;
function parseIntSafe(v, def) {
    if (!v) return def;
    const n = Number.parseInt(v, 10);
    return Number.isFinite(n) && n > 0 ? n : def;
}
async function getServerClient() {
    const url = ("TURBOPACK compile-time value", "https://mmrzhazdbqrwipxpygbn.supabase.co");
    const serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;
    if (url && serviceKey) {
        const client = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$supabase$2f$supabase$2d$js$2f$dist$2f$module$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["createClient"])(url, serviceKey, {
            auth: {
                persistSession: false,
                autoRefreshToken: false
            }
        });
        return {
            client,
            isAdmin: true
        };
    }
    const client = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$supabase$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["supabaseServer"])();
    // @ts-expect-error helper retorna SupabaseClient
    return {
        client,
        isAdmin: false
    };
}
function paginate(arr, page, pageSize) {
    const total = arr.length;
    const pages = Math.max(1, Math.ceil(total / pageSize));
    const from = (page - 1) * pageSize;
    const to = from + pageSize;
    const slice = arr.slice(from, to);
    return {
        slice,
        total,
        pages
    };
}
function chooseName(p) {
    return p?.full_name && String(p.full_name).trim() || p?.name && String(p.name).trim() || p?.email || null;
}
async function fillNames(supabase, ids, opts) {
    const map = new Map();
    if (!ids.length) return map;
    // 1) profiles (somente colunas existentes)
    try {
        const { data: profs } = await supabase.from("profiles").select("id,full_name,name,email").in("id", ids);
        if (Array.isArray(profs)) {
            for (const p of profs){
                if (!p?.id) continue;
                map.set(p.id, {
                    name: chooseName(p),
                    email: p?.email ?? null
                });
            }
        }
    } catch  {
    // RLS pode bloquear; seguimos para fallback se houver service role
    }
    const missing = ids.filter((id)=>!map.has(id));
    if (!missing.length) return map;
    // 2) auth.users (somente se houver service role)
    if (opts.isAdmin) {
        try {
            const { data: users } = await supabase.schema("auth").from("users").select("id, email, raw_user_meta_data").in("id", missing);
            if (Array.isArray(users)) {
                for (const u of users){
                    const meta = u?.raw_user_meta_data || {};
                    const nm = chooseName({
                        full_name: meta.full_name,
                        name: meta.name,
                        email: u?.email
                    }) || u?.email || null;
                    if (u?.id) map.set(u.id, {
                        name: nm,
                        email: u?.email ?? null
                    });
                }
            }
        } catch  {
        // ignora
        }
    }
    return map;
}
async function GET(req) {
    const url = new URL(req.url);
    const page = Math.max(1, parseIntSafe(url.searchParams.get("page"), 1));
    const pageSize = Math.min(100, Math.max(1, parseIntSafe(url.searchParams.get("pageSize"), 25)));
    try {
        const { client: supabase, isAdmin } = await getServerClient();
        // 1) VIEW
        try {
            const { data, error, count } = await supabase.from("user_points_view").select("user_id,total,points,name,full_name,email", {
                count: "exact"
            }).order("total", {
                ascending: false
            }).range((page - 1) * pageSize, page * pageSize - 1);
            if (!error && Array.isArray(data)) {
                let leaderboard = data.filter((r)=>!!r.user_id).map((r)=>{
                    const pts = (typeof r.total === "number" && Number.isFinite(r.total) ? r.total : null) ?? (typeof r.points === "number" && Number.isFinite(r.points) ? r.points : 0);
                    const display = chooseName(r);
                    return {
                        user_id: r.user_id,
                        name: display,
                        email: r.email ?? null,
                        points: pts,
                        total: pts
                    };
                });
                // backfill nomes faltantes
                const missingIds = leaderboard.filter((i)=>!i.name).map((i)=>i.user_id);
                if (missingIds.length) {
                    const names = await fillNames(supabase, missingIds, {
                        isAdmin
                    });
                    leaderboard = leaderboard.map((row)=>row.name ? row : {
                            ...row,
                            name: names.get(row.user_id)?.name ?? row.name ?? null,
                            email: names.get(row.user_id)?.email ?? row.email ?? null
                        });
                }
                return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                    ok: true,
                    leaderboard,
                    page,
                    pageSize,
                    total: typeof count === "number" ? count : leaderboard.length,
                    pages: typeof count === "number" ? Math.max(1, Math.ceil(count / pageSize)) : 1,
                    via: "view",
                    adminClient: isAdmin
                }, {
                    headers: {
                        "Cache-Control": "no-store"
                    }
                });
            }
        } catch  {}
        // 2) Fallback progress
        try {
            const { data, error } = await supabase.from("progress").select("user_id,points").returns();
            if (!error && Array.isArray(data)) {
                const totals = new Map();
                for (const r of data){
                    if (!r.user_id) continue;
                    totals.set(r.user_id, (totals.get(r.user_id) ?? 0) + (Number(r.points) || 0));
                }
                const rows = [
                    ...totals.entries()
                ].map(([user_id, total])=>({
                        user_id,
                        total
                    })).sort((a, b)=>b.total - a.total);
                const { slice, total, pages } = paginate(rows, page, pageSize);
                const ids = slice.map((r)=>r.user_id);
                const names = await fillNames(supabase, ids, {
                    isAdmin
                });
                const leaderboard = slice.map((r)=>{
                    const p = names.get(r.user_id);
                    const val = r.total ?? 0;
                    return {
                        user_id: r.user_id,
                        name: p?.name ?? null,
                        email: p?.email ?? null,
                        points: val,
                        total: val
                    };
                });
                return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                    ok: true,
                    leaderboard,
                    page,
                    pageSize,
                    total,
                    pages,
                    via: "progress",
                    adminClient: isAdmin
                }, {
                    headers: {
                        "Cache-Control": "no-store"
                    }
                });
            }
        } catch  {}
        // 3) Fallback points
        const { data: pointsRows, error: pointsErr } = await supabase.from("points").select("user_id,value").returns();
        if (pointsErr) throw pointsErr;
        const totals = new Map();
        for (const r of pointsRows ?? []){
            if (!r.user_id) continue;
            totals.set(r.user_id, (totals.get(r.user_id) ?? 0) + (Number(r.value) || 0));
        }
        const rows = [
            ...totals.entries()
        ].map(([user_id, total])=>({
                user_id,
                total
            })).sort((a, b)=>b.total - a.total);
        const { slice, total, pages } = paginate(rows, page, pageSize);
        const ids = slice.map((r)=>r.user_id);
        const names = await fillNames(supabase, ids, {
            isAdmin
        });
        const leaderboard = slice.map((r)=>{
            const p = names.get(r.user_id);
            const val = r.total ?? 0;
            return {
                user_id: r.user_id,
                name: p?.name ?? null,
                email: p?.email ?? null,
                points: val,
                total: val
            };
        });
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            ok: true,
            leaderboard,
            page,
            pageSize,
            total,
            pages,
            via: "points",
            adminClient: isAdmin
        }, {
            headers: {
                "Cache-Control": "no-store"
            }
        });
    } catch (err) {
        console.error("[/api/ranking] error:", err?.message || err);
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            ok: false,
            error: err?.message ?? "server_error"
        }, {
            status: 500
        });
    }
}
}),
];

//# sourceMappingURL=%5Broot-of-the-server%5D__b693062f._.js.map
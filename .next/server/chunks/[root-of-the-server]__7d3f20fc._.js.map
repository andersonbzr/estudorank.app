{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 3, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 91, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/adsli/EstudoRank-patched-2025-10-22/estudorank/src/app/api/account/delete/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\r\nimport { createClient } from \"@supabase/supabase-js\";\r\n\r\nexport const dynamic = \"force-dynamic\";\r\n\r\n/** Extrai access_token dos cookies do Supabase (sb-<ref>-auth-token) */\r\nfunction tokenFromSupabaseCookie(cookieHeader: string | null): string | null {\r\n  if (!cookieHeader) return null;\r\n  try {\r\n    // procura por qualquer cookie do tipo sb-*-auth-token\r\n    const parts = cookieHeader.split(/;\\s*/);\r\n    const kv = parts.find((p) => /^sb-[^.=]+-auth-token=/.test(p));\r\n    if (!kv) return null;\r\n\r\n    const raw = decodeURIComponent(kv.split(\"=\").slice(1).join(\"=\"));\r\n    // esse cookie geralmente é um JSON com access_token dentro\r\n    try {\r\n      const j = JSON.parse(raw);\r\n      return (\r\n        j?.access_token ||\r\n        j?.currentSession?.access_token ||\r\n        j?.session?.access_token ||\r\n        null\r\n      );\r\n    } catch {\r\n      // em alguns setups pode vir o próprio JWT\r\n      return raw.includes(\".\") ? raw : null;\r\n    }\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\n/** Extrai token do header Authorization: Bearer x */\r\nfunction tokenFromAuthHeader(req: NextRequest): string | null {\r\n  const h =\r\n    req.headers.get(\"authorization\") || req.headers.get(\"Authorization\");\r\n  if (!h) return null;\r\n  return h.startsWith(\"Bearer \") ? h.slice(7).trim() : null;\r\n}\r\n\r\nexport async function POST(req: NextRequest) {\r\n  try {\r\n    const url = process.env.NEXT_PUBLIC_SUPABASE_URL!;\r\n    const anon = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;\r\n    const serviceRole = process.env.SUPABASE_SERVICE_ROLE_KEY;\r\n\r\n    if (!url || !anon || !serviceRole) {\r\n      return NextResponse.json(\r\n        { ok: false, error: \"supabase_env_missing\" },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n    // 1) tenta Authorization\r\n    let token = tokenFromAuthHeader(req);\r\n\r\n    // 2) tenta querystring ?token=\r\n    if (!token) token = req.nextUrl.searchParams.get(\"token\");\r\n\r\n    // 3) tenta body JSON { access_token }\r\n    if (!token) {\r\n      try {\r\n        const body = await req.json().catch(() => null);\r\n        token = body?.access_token ?? null;\r\n      } catch {\r\n        /* ignore */\r\n      }\r\n    }\r\n\r\n    // 4) tenta cookies do Supabase (sb-<ref>-auth-token)\r\n    if (!token) token = tokenFromSupabaseCookie(req.headers.get(\"cookie\"));\r\n\r\n    if (!token) {\r\n      return NextResponse.json(\r\n        { ok: false, error: \"unauthorized_no_token\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    // Valida o token com cliente \"anon\" + Authorization\r\n    const userClient = createClient(url, anon, {\r\n      auth: { persistSession: false },\r\n      global: { headers: { Authorization: `Bearer ${token}` } },\r\n    });\r\n\r\n    const { data: userData, error: userErr } = await userClient.auth.getUser();\r\n    const uid = userData?.user?.id;\r\n    if (userErr || !uid) {\r\n      return NextResponse.json(\r\n        { ok: false, error: \"unauthorized_bad_token\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    // Admin client (service role) para deletar dados + usuário\r\n    const admin = createClient(url, serviceRole, { auth: { persistSession: false } });\r\n\r\n    // (Opcional) limpezas de dados do usuário antes\r\n    // await admin.from(\"progress\").delete().eq(\"user_id\", uid);\r\n    // await admin.from(\"points\").delete().eq(\"user_id\", uid);\r\n    // ...adicione outras tabelas se quiser\r\n\r\n    const { error: delErr } = await admin.auth.admin.deleteUser(uid);\r\n    if (delErr) {\r\n      return NextResponse.json(\r\n        { ok: false, error: delErr.message || \"delete_failed\" },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n    return NextResponse.json({ ok: true });\r\n  } catch (e: any) {\r\n    return NextResponse.json(\r\n      { ok: false, error: e?.message ?? \"server_error\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}
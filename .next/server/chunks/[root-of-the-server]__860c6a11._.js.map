{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 3, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 91, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/adsli/EstudoRank-patched-2025-10-22/estudorank/src/app/api/admin/users/list/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\nimport { createClient } from \"@supabase/supabase-js\";\r\n\r\nexport const dynamic = \"force-dynamic\";\r\n\r\nfunction requireAdminSecret() {\r\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL;\r\n  const key = process.env.SUPABASE_SERVICE_ROLE_KEY;\r\n  if (!url || !key) throw new Error(\"Service Role não configurado.\");\r\n  return { url, key };\r\n}\r\n\r\n/**\r\n * GET /api/admin/users/list?q=&page=1&perPage=20\r\n * Usa auth.admin.listUsers para obter email + id.\r\n * Também tenta enriquecer com \"profiles\" (name/full_name).\r\n */\r\nexport async function GET(req: Request) {\r\n  try {\r\n    const { url, key } = requireAdminSecret();\r\n    const admin = createClient(url, key, {\r\n      auth: { persistSession: false, autoRefreshToken: false },\r\n    });\r\n\r\n    const u = new URL(req.url);\r\n    const q = (u.searchParams.get(\"q\") || \"\").toLowerCase().trim();\r\n    const page = Math.max(1, parseInt(u.searchParams.get(\"page\") || \"1\", 10));\r\n    const perPage = Math.min(50, Math.max(1, parseInt(u.searchParams.get(\"perPage\") || \"20\", 10)));\r\n\r\n    // Lista usuários (pagina no Auth)\r\n    const { data, error } = await admin.auth.admin.listUsers({\r\n      page,\r\n      perPage,\r\n    });\r\n    if (error) throw error;\r\n\r\n    const all = (data?.users || []).map(u => ({\r\n      id: u.id,\r\n      email: u.email ?? null,\r\n      created_at: u.created_at ?? null,\r\n    }));\r\n\r\n    // filtro rápido por q (email/id)\r\n    const filtered = q\r\n      ? all.filter(it =>\r\n          (it.email || \"\").toLowerCase().includes(q) || it.id.toLowerCase().includes(q)\r\n        )\r\n      : all;\r\n\r\n    // Enriquecer com profiles (name/full_name)\r\n    let enriched = filtered;\r\n    if (filtered.length) {\r\n      const ids = filtered.map(f => f.id);\r\n      const { data: profs } = await admin\r\n        .from(\"profiles\")\r\n        .select(\"id,name,full_name\")\r\n        .in(\"id\", ids);\r\n      const map = new Map<string, { name?: string | null; full_name?: string | null }>();\r\n      (profs || []).forEach((p: any) => map.set(p.id, { name: p.name, full_name: p.full_name }));\r\n\r\n      enriched = filtered.map(it => {\r\n        const p = map.get(it.id);\r\n        const display =\r\n          (p?.name && String(p.name).trim()) ||\r\n          (p?.full_name && String(p.full_name).trim()) ||\r\n          it.email ||\r\n          null;\r\n        return { ...it, display_name: display };\r\n      });\r\n    }\r\n\r\n    return NextResponse.json({\r\n      ok: true,\r\n      users: enriched,\r\n      page,\r\n      perPage,\r\n      count: enriched.length,\r\n    });\r\n  } catch (err: any) {\r\n    return NextResponse.json({ ok: false, error: err?.message ?? \"server_error\" }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;;;AAAA;AACA;;;AAEO,MAAM,UAAU;AAEvB,SAAS;IACP,MAAM;IACN,MAAM,MAAM,QAAQ,GAAG,CAAC,yBAAyB;IACjD,IAAI,CAAC,OAAO,CAAC,KAAK,MAAM,IAAI,MAAM;IAClC,OAAO;QAAE;QAAK;IAAI;AACpB;AAOO,eAAe,IAAI,GAAY;IACpC,IAAI;QACF,MAAM,EAAE,GAAG,EAAE,GAAG,EAAE,GAAG;QACrB,MAAM,QAAQ,IAAA,yMAAY,EAAC,KAAK,KAAK;YACnC,MAAM;gBAAE,gBAAgB;gBAAO,kBAAkB;YAAM;QACzD;QAEA,MAAM,IAAI,IAAI,IAAI,IAAI,GAAG;QACzB,MAAM,IAAI,CAAC,EAAE,YAAY,CAAC,GAAG,CAAC,QAAQ,EAAE,EAAE,WAAW,GAAG,IAAI;QAC5D,MAAM,OAAO,KAAK,GAAG,CAAC,GAAG,SAAS,EAAE,YAAY,CAAC,GAAG,CAAC,WAAW,KAAK;QACrE,MAAM,UAAU,KAAK,GAAG,CAAC,IAAI,KAAK,GAAG,CAAC,GAAG,SAAS,EAAE,YAAY,CAAC,GAAG,CAAC,cAAc,MAAM;QAEzF,kCAAkC;QAClC,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,MAAM,IAAI,CAAC,KAAK,CAAC,SAAS,CAAC;YACvD;YACA;QACF;QACA,IAAI,OAAO,MAAM;QAEjB,MAAM,MAAM,CAAC,MAAM,SAAS,EAAE,EAAE,GAAG,CAAC,CAAA,IAAK,CAAC;gBACxC,IAAI,EAAE,EAAE;gBACR,OAAO,EAAE,KAAK,IAAI;gBAClB,YAAY,EAAE,UAAU,IAAI;YAC9B,CAAC;QAED,iCAAiC;QACjC,MAAM,WAAW,IACb,IAAI,MAAM,CAAC,CAAA,KACT,CAAC,GAAG,KAAK,IAAI,EAAE,EAAE,WAAW,GAAG,QAAQ,CAAC,MAAM,GAAG,EAAE,CAAC,WAAW,GAAG,QAAQ,CAAC,MAE7E;QAEJ,2CAA2C;QAC3C,IAAI,WAAW;QACf,IAAI,SAAS,MAAM,EAAE;YACnB,MAAM,MAAM,SAAS,GAAG,CAAC,CAAA,IAAK,EAAE,EAAE;YAClC,MAAM,EAAE,MAAM,KAAK,EAAE,GAAG,MAAM,MAC3B,IAAI,CAAC,YACL,MAAM,CAAC,qBACP,EAAE,CAAC,MAAM;YACZ,MAAM,MAAM,IAAI;YAChB,CAAC,SAAS,EAAE,EAAE,OAAO,CAAC,CAAC,IAAW,IAAI,GAAG,CAAC,EAAE,EAAE,EAAE;oBAAE,MAAM,EAAE,IAAI;oBAAE,WAAW,EAAE,SAAS;gBAAC;YAEvF,WAAW,SAAS,GAAG,CAAC,CAAA;gBACtB,MAAM,IAAI,IAAI,GAAG,CAAC,GAAG,EAAE;gBACvB,MAAM,UACJ,AAAC,GAAG,QAAQ,OAAO,EAAE,IAAI,EAAE,IAAI,MAC9B,GAAG,aAAa,OAAO,EAAE,SAAS,EAAE,IAAI,MACzC,GAAG,KAAK,IACR;gBACF,OAAO;oBAAE,GAAG,EAAE;oBAAE,cAAc;gBAAQ;YACxC;QACF;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,IAAI;YACJ,OAAO;YACP;YACA;YACA,OAAO,SAAS,MAAM;QACxB;IACF,EAAE,OAAO,KAAU;QACjB,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,IAAI;YAAO,OAAO,KAAK,WAAW;QAAe,GAAG;YAAE,QAAQ;QAAI;IAC/F;AACF","debugId":null}}]
}